\chapter{Type Preservation}

If a well-typed term takes a step of evaluation, then the resulting term is also well-typed.

\begin{proposition}
If $\Gamma \vdash t : T$ and $t \derives{} t'$, then $\Gamma \vdash t' : T$
\end{proposition}

\begin{proof}
By induction on a derivation of $t:T$.  At each step, we assume that
the desired property holds for all subderivations and proceed by case
analysis on the final rule in the derivation.

\case{Nil}: $t = \nil$, $T = g$

\noindent If the last rule in the derivation is $Nil$, then we know
from the form of the rule that $t$ must be the process term $\nil$ and
$T$ must be the type $g$ where $g : Group$.  From the semantics
($Idle$), $\nil$ has a transition $\nil \derives{\sigma} \nil$ for
each clock $\sigma$ in $\timers$.  In each case, $t' = \nil$ which, by
the $Nil$ rule, has type $g$ so our proposition is satisfied.

\case{BNil}: $t = \Omega$, $T = Bouncer$

\noindent If the last rule in the derivation is $BNil$, then we know
from the form of the rule that $t$ must be the process term $\Omega$
and $T$ must be the type $Bouncer$.  From the semantics, there are no
transitions for $\Omega$ so there is nothing to prove.

\case{Stop}: $t = \Delta$, $T = g$

\noindent If the last rule in the derivation is $Stop$, then we know
from the form of the rule that $t$ must be the process term $\Delta$
and $T$ must be the type $g$ where $g : Group$.  From the semantics,
there are no transitions for $\Delta$ so there is nothing to prove.

\case{Stall}: $t = \Delta_\sigma$, $T = g$

\noindent If the last rule in the derivation is $Stall$, then we know
from the form of the rule that $t$ must be the process term
$\Delta_\sigma$ and $T$ must be the type $g$ where $g : Group$.  From
the semantics ($Stall$), $\Delta_\sigma$ has a transition
$\Delta_\sigma \derives{\rho} \Delta_\sigma$ for each clock $\rho$ in
$\timers$ where $\rho \ne \sigma$.  In each case, $t' = \Delta_\sigma$
which, by the $Stall$ rule, has type $g$ so our proposition is
satisfied.

\case{Act}: $t = \alpha.E$, $T = g$

\noindent If the last rule in the derivation is $Act$, then we know
from the form of the rule that $t$ must be the process term
$\alpha.E$ and $T$ must be the type $g$ where $g : Group$.  From
the semantics, there are two subcases:

\subcase{Act}: $t' = E$, $T = g$

\noindent The $Act$ rule from the semantics provides the transition $\alpha.E
\derives{\alpha} E$, so $t'$ is $E$.  From the subderivations of the
$Act$ typing rule, we know that $E : g : Group$ so we can apply the
induction hypothesis to obtain $t' : g$.

\subcase{Patient}: $t' = \alpha.E$, $T = g$

\noindent From the $Patient$ rule of the semantics, $\alpha.E$ has a transition
$\alpha.E \derives{\sigma} \alpha.E$ for each clock $\sigma$ in
$\timers$.  In each case, $t' = \alpha.E$ which, by the $Act$ typing
rule, has type $g$ so our proposition is satisfied.

\case{Rec}: $t = \mu X.E$, $T = g$

\noindent From the $Rec$ rule of the semantics, $\mu X.E$ has a
transition to $E'\{\mu X.E/X\}$ for any transition $\gamma$ which can
be performed by $E$.  In each case, $t' = E'\{\mu X.E/X\}$ so we need
to show that this is well-typed.  From the subderivations of the $Rec$
typing rule, we know that $E : g : Group$ so we can apply the
induction hypothesis to obtain $E' : g : Group$.  So, we just need to
show that the well-typedness of $E'$ is preserved when the
substitution ($\{\mu X.E/X\}$ is performed.

\begin{lemma}
If $\Gamma, E : S \vdash t : T$ and $\Gamma \vdash E : S$ then $\Gamma \vdash E\{\mu X.E/X\} : T$
\end{lemma}

\begin{proof}
By induction on a derivation of the statement $\Gamma, E : S \vdash t
: T$.  For a given derivation, we proceed by cases on the final typing
rule.
\end{proof}

\end{proof}

